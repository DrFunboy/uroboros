(IN `idsportsmen` INT, IN `idpay` INT, IN `sumpay` DECIMAL(10,2)) MODIFIES SQL DATA 
BEGIN

DECLARE idinvoice int;
DECLARE sumremain decimal(10,2);
DECLARE done SMALLINT DEFAULT 0;

DECLARE c_invoice CURSOR FOR
SELECT i.id, (i.`sum` - IFNULL(SUM(ip.`sum`), 0)) as sum_remain
FROM @@@invoice i LEFT JOIN @@@invoicepay ip ON (ip.idinvoice = i.id)
WHERE i.sportsmen = idsportsmen AND i.`sum` > 0 
GROUP BY i.id
HAVING sum_remain > 0
ORDER BY i.dateinvoice, i.created;

DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

Open c_invoice;
REPEAT
  FETCH c_invoice INTO idinvoice, sumremain;
  IF NOT done THEN
		set sumremain = LEAST(sumpay, sumremain);
		/* уменьшаем суммy остатка до суммы платежа 1 */
    insert into @@@invoicepay (`idinvoice`,`idpay`,`sum`) VALUES (idinvoice, idpay, sumremain);
    set sumpay = sumpay - sumremain; /* остаток платежа после вставки */
  END IF;
UNTIL (done OR sumpay = 0) END REPEAT;
Close c_invoice;

END