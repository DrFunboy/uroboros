<style>
    .table-wo-border tr:first-child td,
    .table-wo-border tr:first-child th {
        border-top: 0;
    }
</style>
<div id="tableTabs">
    <div class="ml-auto top2Nav">
        <a href="javascript:window.print();" class="btn btn-light btn-icon"><i class="fa fa-print"></i></a>
    </div>

    <div class="tab-content card">
        [[$panelPeriod]]
        <div class="card-header" id="tablePeriod"></div>
        <div id="tbl_counts" class="tab-pane active table-responsive card-body"
            data-link="{if sum tmpl='#tpl_counts'}">
            Loading ...
        </div>
        <div id="tbl_byday" class="tab-pane card-body" data-link="{if tbl_params tmpl='#tpl_byday'}"></div>
        <div id="tbl_rating" class="tab-pane card-body" data-link="{include tmpl='#tpl_rating'}"></div>
    </div>
</div>

<script id="tpl_counts" type="text/x-jsrender">
<table class="table table-bordered1 table-hover m-0 w-auto">
<thead>
    <tr>
        <th>
        <select class="form-control form-control-sm custom-select1 custom-select-sm1" data-link="sum_type">
        {{props sum_types}}
            <option value="{{>key}}">{{:~root.rate_types[key]}}</option>
        {{/props}}
        </select>
        </th>
        <th>
            <a href="#" data-link="{on ~showDetails}">
            {^{:rate_types[ sum_types[sum_type] ]}}
            </a>
        </th>
    </tr>
</thead>
<tbody>
    {^{props sum[sum_type] sort="prop.name"}}
    <tr>
        <td>
            <a href="#" data-link="{on ~selRow ''}" class="d-flex">
                <span class="mr-auto">{{:prop.name}}</span>
                <span>
                    <span class="badge badge-primary ml-3">{{>prop.cnt}}</span>
                </span>
            </a>
        </td>
        <td>
            {^{props prop^rows sort="prop.name" ~k=key}}
                <a href="#" class="d-flex" data-link="{on ~selRow ~k} class{merge:#index>0 toggle='border-top pt-2 mt-2'}">
                    <span class="mr-auto">{{:prop.name}}</span>
                    <span>
                        <span class="badge badge-success ml-3">{{>prop.cnt}}</span>
                    </span>
                </a>
            {{else}}
                <a href="#" class="pull-right badge badge-success" data-link="{on ~showDetails}">{{:~objLength(prop.details)}}</a>
            {{/props}}
        </td>
        [[-<td>{{>prop.cnt_y}}</td>
        <td>{{>prop.cnt_lesson}}</td>]]
    </tr>
    {{/props}}
</tbody>
<tfoot>
    <tr>
    <td colspan="2">Итого: <b>{^{>sum^cnt}}</b></td>
    </tr>
</tfoot>
</table>
</script>

<script id="tpl_byday" type="text/x-jsrender">
<table class="table table-wo-border w-auto">
    <tbody>
    {^{for tbl_params ~sqtype=sqtype}}
        <tr>
            <th data-id="{{:id}}" data-key="{{:key}}">{{:~root.rate_types[key]}}</th>
            <td>
                {{:name}}
                <div data-link="{radiogroup ~sqtype} visible{:key=='squad'}" class="mt-1">
                    <div class="custom-control custom-control-inline custom-radio">
                        <input type="radio" class="custom-control-input" name="sqtype" id="sqtype1" value="idSchedule.squad">
                        <label class="custom-control-label" for="sqtype1">По расписанию</label>
                    </div>
                    <div class="custom-control custom-control-inline custom-radio">
                        <input type="radio" class="custom-control-input" name="sqtype" id="sqtype2" value="idSportsmen.squad">
                        <label class="custom-control-label" for="sqtype2">По спортсменам</label>
                    </div>
                </div>
            </td>
        </tr>
    {{/for}}
    </tbody>
</table>

<span class="spinner-grow" role="status" data-link="visible{:tdata=='loading'}"></span>

{^{if tdata!='loading' ~td=tdata ~tdsp=tdata.sp ~dm=tdata.dm  ~spfld=sp_field}}
<div class="table-responsive">
    <table class="table table-bordered table-sm table-hover text-center w-auto">
        <thead>
            <tr>
                <td colspan="2">
                    <select class="custom-select custom-select-sm" data-link="ttype">
                        <option value="lesson">Посещаемость</option>
                        <option value="mark">Оценки</option>
                    </select>
                </td>
                {{props ~dm sort="prop.datestart"}}
                    <th colspan="{{:prop.sch.length}}">{{>key}}</th>
                {{/props}}
                 {^{if ~root^ttype=='mark'}}
                <th colspan="2">Оценки</th>
                {{/if}}
                <th rowspan="2">{{fmtStatus:'y' tbl='idLesson'}}</th>
                <th rowspan="2">Всего</th>
            </tr>
            <tr>
                <th>N</th>
                <th>Ф.И.О.</th>
                {{props ~dm sort="prop.datestart" }}
                    {{for prop.sch sort="datestart"}}
                        <th class="small">{{:ssportname}}<br>{{:d_s}}</th>
                    {{/for}}
                {{/props}}
                 {^{if ~root^ttype=='mark'}}
                    <th>Сум</th>
                    <th>Ср</th>
                {{/if}}
            </tr>
        </thead>
        <tbody>
            {{props ~tdsp sort="prop.name" itemVar="~sp"}} 
            <tr>
                <td class="text-right" data-id="{{:key}}">{{:#index+1}}</td>
                <td class="text-left">
                    <b>{{:prop.name}}</b>
                    <div data-link="{for ~spflds(~spfld, ~tdsp, key) tmpl='#tpl_spflds'}"></div>
                </td>
                
                {{props ~dm sort="prop.datestart"}}
                    {{for prop.sch sort="datestart" tmpl="#tpl_tableCell" /}}
                {{/props}}
                {^{if ~root^ttype=='mark'}}
                    <td data-link="{:~sp.prop.mark_sum||''}"></td>
                    <td data-link="{:~sp.prop.mark_cnt? ~Util.round2(~sp.prop.mark_sum/~sp.prop.mark_cnt):''}"></td>
                {{/if}}
                <td>{{:~sp.prop.cnt_y}}</td>
                <td>{{:~sp.prop.cnt}}</td>
            </tr>
            {{/props}}
        </tbody>
        <tfoot>
            <tr>
                <th class="text-right" colspan="2">{{fmtStatus:'y' tbl='idLesson'}}</th>
                {{props ~dm sort="prop.datestart"}}
                    {{for prop.sch sort="datestart"}}
                    <td>{{:~td['sch'+schedule+'y']}}</td>
                    {{/for}}
                {{/props}}
                {^{if ~root^ttype=='mark'}}
                <th rowspan="2" colspan="2"></th>
                {{/if}}
                <th class="bg-secondary">{{:cnt_y}}</th>
                <th></th>
            </tr>
            <tr>
                <th class="text-right" colspan="2">Всего</th>
                {{props ~dm sort="prop.datestart"}}
                    {{for prop.sch sort="datestart"}}
                    <td>{{:~td['sch_cnt'+schedule]}}</td>
                    {{/for}}
                {{/props}}
                <th></th>
                <th class="bg-secondary">{{:cnt}}</th>
            </tr>
        </tfoot>
    </table>
</div>
    
<div class="text-muted d-print-none" data-link="{checkboxgroup sp_field}">
    {{props sp_fields}}
        <div class="custom-control custom-control-inline custom-checkbox">
            <input type="checkbox" class="custom-control-input"
                id="spf_{{:key}}" name="spf_{{:key}}" value="{{:key}}">
            <label class="custom-control-label" for="spf_{{:key}}">
                {{:prop}}
            </label>
        </div>
    {{/props}}
</div>
{{/if}}
</script>

<script id="tpl_spflds" type="text/x-jsrender">
    <div class="mt-1 small">
        {{if field=='saldo'}}
            {{include sp tmpl='#tpl_spSaldo' /}}
        {{else field=='email'}}
            <a href="mailto:{{:value}}" target="_blank">{{:value}}</a>
        {{else field=='tel'}}
            <a href="#" class="telPopover">{{:value}}</a>
        {{else}}
            {{:value}}
        {{/if}}
    </div>
</script>

<script id="tpl_tableCell" type="text/x-jsrender">
{^{if ~sp.prop.sch[schedule] ~s=~sp.prop.sch[schedule] }}
    <td class="small" data-link="class{merge:~s.wo_invoice toggle='table-warning'}">
        {^{if ~root^ttype=='mark' && ~s.mark && ~s.mark!='0'}}
            {{:~s.mark}}
        {{else}}
            {{fmtStatus:~s.status tbl='idLesson'}}
        {{/if}}
    </td>
{{else}}
    <td></td>
{{/if}}
</script>

[[- =====*===== RATING =====*===== ]]

<script id="tpl_rating" type="text/x-jsrender">
{^{if rate && rate^trainer}}
<div class="form-group">
    {^{radiogroup rate_type}}
        {{props rate_types}}
        <div class="custom-control custom-control-inline custom-radio">
            <input type="radio" class="custom-control-input" name="rate_type" id="rate_{{>key}}" value="{{>key}}">
            <label class="custom-control-label" for="rate_{{>key}}">{{>prop}}</label>
        </div>
        {{/props}}
    {{/radiogroup}}
</div>
<div class="row">
    <div class="col-12 col-md-5">
        <table class="table table-hover table-striped">
            <thead><tr class="small-">
            <th></th>
            <th>К-во спортсменов</th>
            <th>Средний балл</th>
            </tr></thead>
            <tbody>
                {^{for ~getRateRows(rate_type, rate[rate_type]) sort="name" }}
                <tr>
                <td width="85%"><a href="#" data-link="{on 'click' ~getSpRateRows}">{{:name}}</a></td>
                <td>{{:cnt_sp}}</td>
                <td>{{formatDigits:avg}}</td>
                </tr>
                {{/for}}
            </tbody>
        </table>
    </div>
    <div class="col-12 col-md-7">
    {^{if rate_spname}}
        <table class="table table-hover table-sm1">
            <thead><tr>
            <th colspan="2">
            <a href="#" data-link="text{:rate_filter} {on ~backRate}"></a> :: {^{:rate_spname}}
            </th>
            </tr></thead>
            <tbody>
            {^{props rate_spdates sort="key"}}
                <tr>
                    <th colspan="2" class="text-muted">{{formatDateTime:key}}</th>
                </tr>
                {^{for prop}}
                <tr>
                    <td class="pl-4">{{:status_name}}</td>
                    <td data-link="class{:(sum_total)? 'text-success':''}">{{:value}}</td>
                </tr>
                {{/for}}
            {{/props}}
            </tbody>
        </table>
    {{else rate_sprows}}
        <table class="table table-hover table-striped">
            <thead><tr>
            <th><span class="d-md-none">{^{:rate_types[rate_type]}} - </span>{^{:rate_filter}}</th>
            <th>К-во занятий</th>
            <th>Сумма</th>
            </tr></thead>
            <tbody>
                {^{for rate_sprows}}
                <tr>
                <td width="85%">
                    <a href="#" data-link="{on ~getSpRate}">{{:name}}</a>
                </td>
                <td>{{:cnt_rows}}</td>
                <td>{{formatDigits:total}}</td>
                </tr>
                {{/for}}
            </tbody>
        </table>
    {{/if}}
    </div>
</div>

{{else}}
    <div class="alert alert-warning">Нет данных</div>
{{/if}}
</script>

[[$tpl_spSaldo]]

<script>

SCRM.link(SCRM.app, {
    topNavTabs: [
        {href: '#tbl_counts', html: 'Посещаемость', active: true, hook: 'dates'},
        {href: '#tbl_byday', html: 'Табель', hidden: true, hook: 'dates,tbl_params,sqtype'},
        {href: '#tbl_rating', html: 'Аттестация', hook: 'dates'}
    ]
});

SCRM.setClubStatus([[!clubStatus?tbl=`idLesson`]]);

SCRM.tableData = {
    sum: {},
    sum_type: 'trainer',
    sum_types: {
        trainer: 'squad',
        squad: 'trainer'
    },
    rate_type: 'squad',
    rate_types: {
        squad: 'Зал, Группа',
        trainer: 'Тренер'
    },
    sp: {},
    sp_field: [],
    sp_fields: {
        contract: 'Договор',
        saldo: 'Баланс',
        tel: 'Телефон',
        email: 'E-mail',
        contact: 'Контакт'
    },
    sqtype: 'idSchedule.squad',
    ttype: 'lesson'
};

$(function(){
    function _dateStart(v) {
        var t = v.datestart.split(/[- :T]/);
        v.dm = t[2]+'.'+t[1];
        //v.dt = t[3]+':'+t[4];
    }
    
    var tData = SCRM.tableData;
    
    $.link(true, '#tableTabs', tData, {
        spflds: function(spflds, tdsp, key) {
            console.log('spflds', spflds, tdsp, key);
            var sp = tdsp[key];
            return $.map(spflds, function(v, i){
                if (sp[v]) return {field: v, value: sp[v], sp: sp};
            });
            
        },
        RT: function(parent, e, data){
            console.log('RT', parent);
        },
        selRow: function(parent, e, data){
            e.preventDefault();

            var d = data.linkCtx.data;
            var tbl_params = [{
                key: (parent)? tData.sum_types[tData.sum_type] : tData.sum_type,
                id: d.key,
                name: d.prop.name
            }];
            
            if (parent) {
                tbl_params.unshift({
                    key: tData.sum_type,
                    id: parent,
                    name: tData.sum[tData.sum_type][parent].name
                });
            }
            SCRM.link(tData, {tbl_params: tbl_params});
            $('[href="#tbl_byday"]').tab('show');
            SCRM.link(SCRM.app.topNavTabs[1], {hidden: false});
            
            /*var tab = $('a[href="#tbl_byday"]').view();*/
        },
        objLength: function(obj) {
            return array_keys(obj).length;
        },
        showDetails: function(e, data) {
            e.preventDefault();
            var d = data.linkCtx.data;
            var key = tData.sum_type, detail_key = tData.sum_types[key];
            $.each(tData.sum[key], function(i, v){
                if (!d.key || d.key == i) {
                    $.each(v.details, function(n, drow) {
                        drow.name = tData.sum[detail_key][n].name;
                    });
                    SCRM.link(v, {rows: v.details});
                }
            });
        },
        backRate: function(e, data) {
            e.preventDefault();
            SCRM.link(tData, {rate_spname: null});
        },
        getSpRate: function(e, data) {
            e.preventDefault();
            var d = data.linkCtx.data;
            
            getRate({
                _where: 'sportsmen='+ d.id
            }, function(data){
                var nd = {
                    rate_spname: d.name,
                    rate_spdates: {}
                };
                $.each(data.rows, function(i, v) {
                    if (v.status_extended && (v.status_extended.indexOf('sum":"total') > -1)) v.sum_total = 1;
                    key2obj(nd.rate_spdates, v.datestart).push(v);
                });
                SCRM.link(tData, nd);
            });
        },
        getSpRateRows: function(e, data) {
            e.preventDefault();
            var lnk = data.linkCtx.data;
            var sp_rows = getRateRows('sportsmen', function(v) {
                return v[lnk.f] == lnk.id;
            });
            SCRM.link(tData, {
                rate_spname: null,
                rate_sprows: sp_rows,
                rate_filter: lnk.name
            });
        },
        getRateRows:getRateRows
    });
    
    function getRate(opts, callback) {
        pDATA('idRate', $.extend({
            rows: 1001
        }, tData.dates, opts), callback);
    }
    
    function getRateRows(field, filter) {
        var tf = typeof filter;
        var rows = $.map(tData.rate[field], function(r, i){
            var sportsmens = { }; 
            var row = {
                f: field,
                total: 0, cnt_sp: 0, cnt_rows: 0,
                name: r[0][field+'_name'],
                id: r[0][field]
            };
            $.each(r, function(n, v){
                if (tf != 'function' || filter(v)) {
                    if (!sportsmens[v.sportsmen]) {
                        sportsmens[v.sportsmen] = 1;
                        row.cnt_sp++;
                    }
                    row.cnt_rows++;
                    row.total += v.sum_value*1;
                }
            });
            if (row.cnt_sp) {
                row.avg = row.total / row.cnt_sp;
                return row;
            }
        });
        return rows;
    }

    $(document)
    .on('calculate', '[href="#tbl_counts"]', function(e) {
        var tbl = spinnr('#tbl_counts');
        pDATA('idSchedule', $.extend({
            rows: 1001,
            _report: 'idSchedule_table'
        }, tData.dates), function(data){
            var sum = {
                trainer: {},
                squad: {},
                cnt_y: 0, 
                cnt_lesson: 0,
                cnt: 0
            };
            
            function default_obj(name) {
                return {
                    name: name,
                    details: {},
                    cnt: 0
                };
            }

            $.each(data.rows, function(i, v) {
                var sq_name = (v.squad=='0')? '-' : v.clubname+'<br>' + joinStr([v.levelname, v.squadname]);
                var row_sq = key2obj(sum.squad, v.squad, default_obj(sq_name));
                row_sq.cnt += 1;
                
                var row_tr = key2obj(sum.trainer, v.trainer, default_obj(v.trainer_name));
                row_tr.cnt += 1;
                key2obj(row_tr.details, v.squad, {cnt: 0}).cnt += 1;
                key2obj(row_sq.details, v.trainer, {cnt: 0}).cnt += 1;
                
                if (v.trainer2 != '0' && v.trainer2 != v.trainer) {
                    row_tr = key2obj(sum.trainer, v.trainer2, default_obj(v.trainer2_name));
                    row_tr.cnt += 1;
                    key2obj(row_tr.details, v.squad, {cnt: 0}).cnt += 1;
                    key2obj(row_sq.details, v.trainer2, {cnt: 0}).cnt += 1;
                }
                
                sum.cnt += 1;
                sum.cnt_y += v.cnt_y*1;
                sum.cnt_lesson += v.cnt_lesson*1;
            });
            //console.log(sum);
            SCRM.link(tData, {sum: sum});
            spinnr(false, tbl);
        });
    })
    .on('calculate', '[href="#tbl_byday"]', function(e) {
        var tbl = spinnr('#tbl_byday');

        var _where = {};
        $.each(tData.tbl_params, function(i, param) {
            var key = (param.key=='squad')? tData.sqtype : 'idSchedule.'+ param.key;
            _where[key] = param.id;
        });

        SCRM.link(tData, {tdata: 'loading'});
        pDATA('idLesson', $.extend({
            rows: 1001,
            _report: 'idLesson_table',
            _where: _where
        }, tData.dates), function(data){
            var tdata = {dm: {}, sp: {}, sch:{}, cnt: 0};
            $.each(data.rows, function(i, v){
                if (!v.schedule) v.schedule = v.schedule_id;
                
                if (v.status) {
                    var status_key = 'cnt_'+v.status;
                    tdata['sch'+v.schedule+v.status] = (tdata['sch'+v.schedule+v.status] || 0) + 1;
                    tdata['sch_cnt'+v.schedule] = (tdata['sch_cnt'+v.schedule] || 0) + 1;
    
                    var sp = key2obj(tdata.sp, v.sportsmen, {name: v.sportsmen_name, sch:{}, cnt: 0, mark_sum: 0, mark_cnt: 0});
                    v.wo_invoice = ((v.cfg_value||'').indexOf(v.status) > -1) && !v.dateinvoice;
                    if (v.mark) v.mark *= 1;
                    sp.mark_sum += v.mark;
                    if (v.mark) sp.mark_cnt++;

                    sp.sch[v.schedule] = v;
                    sp.cnt += 1;
                    sp[status_key] = (sp[status_key] || 0) + 1;

                    tdata.cnt += 1;
                    tdata[status_key] = (tdata[status_key] || 0) + 1;
                }
                
                _dateStart(v);
                var dm = key2obj(tdata.dm, v.dm, {datestart: v.datestart, sch:[], sch_keys:{}});
                if (!dm.sch_keys[v.schedule]) {
                    dm.sch_keys[v.schedule] = true;
                    dm.sch.push(v);
                }
            });
            
            SCRM.link(tData, {tdata: tdata});
            //console.log(tdata)
            /*if (_where['idSportsmen.squad']) {
                _where['idSchedule.squad'] = _where['idSportsmen.squad'];
                delete _where['idSportsmen.squad'];
            }
            // Если на занятии не было людей, то не будет записи в idLesson
            pDATA('idSchedule', $.extend({
                rows: 1001,
                _report: 'idSchedule_table',
                _where: _where
            }, tData.dates), function(data){
                $.each(data.rows, function(i, v){
                    _dateStart(v);
                    key2obj(tdata.dm, v.dm, {datestart: v.datestart, sch:[]}).sch.push(v);
                });
                SCRM.link(tData, {tdata: tdata});
                //console.log('idSchedule_table', tdata);
            });*/
                
            
            var sp_keys = array_keys(tdata.sp);
            if (sp_keys.length > 0) pDATA('idSportsmen', {
                rows: 1001,
                _where: {id: sp_keys}
            }, function(data) {
                var nspd = {};
                $.each(data.rows, function(i, v) {
                    //nspd[v.id] = $.extend({}, v, tdata.sp[v.id]); //'tdata.sp.'+
                    nspd[v.id] = $.extend({}, v, tdata.sp[v.id]);
                });
                console.log(nspd)
                SCRM.link(tData.tdata, {sp: nspd});
            });
            spinnr(false, tbl);
        });
    })
    .on('calculate', '[href="#tbl_rating"]', function(e) {
        getRate({
            _report: 'RateReport'
        }, function(data){
            var d = {};
        
            function add_d(f, v){
                var row = key2obj(d, f, {});
                key2obj(row, v[f]).push(v)
            }
            $.each(data.rows, function(i, v){
                add_d('squad', v);
                add_d('trainer', v);
                add_d('sportsmen', v);
            });
            SCRM.link(tData, {
                rate: d,
                rate_spname: null,
                rate_sprows: null
            });
        });
    });
    
    $.observe(tData, 'dates', 'tbl_params', 'sqtype', function(e, data){
        $.each(SCRM.app.topNavTabs, function(i, v){
            var hook = (v.hook||'').split(','),
                el = $('a[href="'+ v.href +'"]');
            if (el.length && ($.inArray(data.path, hook) >= 0)) {
                if (el.hasClass('active')) {
                    el.trigger('calculate');
                } else {
                    el.addClass('calculate');
                }
            }
        });
    });

    $('#tablePeriod')
    .on('periodChange', function(e, dates){
        SCRM.link(tData, {dates: dates});
    })
    .panelPeriod();

    $('#tableTabs .top2Nav').appendTo('header.page-navs');
});
</script>