[[!Profile? &prefix=`usr.`]]
[[!clubMsgToAdm]]
<div class="row" id="SCRM">
    <div class="col-lg-8 col-xl-6">
        <form action="" method="post" role="form" enctype="multipart/form-data" class="card card-body" data-link="{on 'submit' new_msg}">
        <fieldset>
            <input type="hidden" name="name" value="[[+usr.fullname]] | [[+usr.mobilephone]]" />
            <input type="hidden" name="email" value="[[+usr.email]]" />
            <div class="form-group">
                <label>От кого</label>
                <a href="/login/profile.html" target="_parent" class="d-block">
                    [[+usr.fullname]] | [[+usr.email]] | [[+usr.mobilephone]]
                </a>
            </div>
            
            <div class="form-group">
                <label for="sd_info" class="control-label">Текст сообщения <abbr>*</abbr></label>
                <textarea  class="form-control" rows="4" id="sd_info" name="info"
                    data-link="sd^info"></textarea>
            </div>
        
            <div class="form-group">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="file" name="file[]" multiple="multiple">
                    <label class="custom-file-label" for="file">Приложить файлы</label>
                </div>
            </div>
            <button type="submit" value="" class="btn btn-sm btn-primary"
                data-link="disabled{:!sd^info||loading}">
                Отправить заявку
                <span class="spinner-border spinner-border-sm" role="status" data-link="visible{:loading}"></span>
            </button>

            <div class="alert alert-success mt-2 mb-0" role="alert"
                data-link="visible{:sd^ok&&!sd^info}">Ваше сообщение отправлено. Специалист ответит в ближайшее время.<br>Копия сообщения отправлена на указанный вами e-mail.</div>
        </fieldset>
        </form>
    </div>
</div>

<script>
$(function(){
    var SCRM = {
        sd: {},
        new_msg: function(e, data) {
            if (!e) return;
        
            e.preventDefault();
            var d = data.linkCtx.data;
            
            var formData = new FormData(e.target);
            $.each(d, function(key, value){
                formData.append(key, value);
            });

            $.observable(d).setProperty('loading', true);
            $.ajax({
                url: window.location,
                type: 'POST',
                //dataType: 'json',
                data: formData,
                cache: false,
                processData: false,
                contentType: false, // Set to false as jQuery will tell the server its a query string request
                success: function(data){
                    $.observable(d).setProperty({
                        sd: {ok: data},
                        loading: false
                    });
                },
            })
            .fail(failXHR);
        }
    };

    $.link(true, '#SCRM', SCRM);

    $('.custom-file > .custom-file-label').each(function () {
        $(this).data('label', $(this).text())
    })

    // update label text with current input value
    $(document).on('change', '.custom-file > .custom-file-input', function () {
        const files = this.files
        const $fileLabel = $(this).next('.custom-file-label')
        // use when no file chosen
        const $originLabel = $fileLabel.data('label')
        
        // truncate text when user chose more than 2 files
        $fileLabel.text(files.length + ' files selected')
        
        if (files.length <= 2) {
            let fileNames = []
            for (let i = 0; i < files.length; i++) {
                fileNames.push(files[i].name);
            }
            $fileLabel.text(fileNames.join(', '));
        }
        
        // reset label text if no file chosen
        if (!files.length) {
            $fileLabel.text($originLabel);
        }
    });
});
</script>

[[-!FormIt?
    &hooks=`email,redirect`
    &redirectTo=`[[*id]]`
    &redirectParams=`{"success":"1"}`
    &emailTpl=`mailHelp`
    &emailTo=`[[!++emailsender]]`
    &emailCC=`[[+mail]]`
    &emailReplyTo=`[[+mail]]`
    &emailBCC=`admin@sportcrm.club,[[!++emailtech]]`
    &emailSubject=`Сообщение с сайта [[!++site_name]]`
    &validate=`name:required,
      mail:email:required,
      text:required:stripTags`
    &attachFilesToEmail=`1`
    &errTpl=`<span class="text-danger">[[+error]]</span>`
    &validationErrorBulkTpl=`<div class="alert alert-danger" role="alert">[[+error]]</div>`
]]    
[[-<div class="card card-body">
    [[-!#GET.success:notempty=`<div class="alert alert-success" role="alert">Ваше сообщение отправлено. Специалист ответит в ближайшее время.<br>Копия сообщения отправлена на указанный вами e-mail.</div>`]]

    [[-!+fi.error_message]]
    <form action="[[~[[*id]]]]" method="post" role="form" enctype="multipart/form-data">
    <input type="hidden" name="city" value="[[+usr.city]]" />
    <fieldset>
        <input type="hidden" name="name" value="[[+usr.fullname]] | [[+usr.mobilephone]]" />[[!+fi.error.name]]
        <input type="hidden" name="mail" value="[[+usr.email]]" />[[!+fi.error.mail]]
        <div class="form-group">
            <label>От кого</label>
            <div>
            <a href="/login/profile.html" target="_parent">
                [[+usr.fullname]] | [[+usr.email]] | [[+usr.mobilephone]]
            </a>
            </div>
        </div>
        <div class="form-group">
            <label for="text">Текст сообщения <abbr>*</abbr></label>
            <textarea name="text" id="text" class="form-control" rows="4">[[!+fi.text]]</textarea>
            [[!+fi.error.text]]
        </div>
        <div class="form-group">
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="file" name="file[]" multiple="multiple">
                <label class="custom-file-label" for="file">Приложить файлы</label>
            </div>
            [[!+fi.error.contact_attachment]]
        </div>
        <input type="submit" value="Отправить сообщение" class="btn btn-primary btn-sm" />
    </fieldset>
    </form>
</div>]]