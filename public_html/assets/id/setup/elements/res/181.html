<!-- clubReport -->
<div id="ratingReport" data-link="{include tmpl='#rating_tpl'}"></div>
<script id="rating_tpl" type="text/x-jsrender">
{^{if d && d^trainer}}
<div class="row">
    <div class="col-12 col-md-4">
        {{for rfields itemVar="~f"}}
        <table class="table table-hover table-striped">
            <thead><tr class="small">
            <th>{{:~root.fields[~f]}}</th>
            <th>К-во спортсменов</th>
            <th>Средний балл</th>
            </tr></thead>
            <tbody>
                {^{for ~getFrows(~f, ~root^d[~f]) }}
                <tr>
                <td width="85%"><a href="#" data-link="{on 'click' ~showRows ~f}">{{:name}}</a></td>
                <td>{{:cnt_sp}}</td>
                <td>{{formatDigits:avg}}</td>
                </tr>
                {{/for}}
            </tbody>
        </table>
        {{/for}}
    </div>
    <div class="col-12 col-md-8">
    {^{if spData}}
        <table class="table table-hover table-sm1">
            <thead><tr class="small">
            <th colspan="2">
                <button type="button" class="btn btn-outline-secondary btn-xs my-n2 mr-2" data-link="{on ~showSp0}">
                <i class="fa fa-chevron-left"></i>
                </button> {^{:sp_filter_name}} - {^{:sp_filter}} :: {^{:sp_name}}
            </th>
            </tr></thead>
            <tbody>
                {^{for spDates}}
                <tr>
                <th colspan="2">{{formatDateTime:#data}}</th>
                </tr>
                    {^{for ~spDate(#data)}}
                    <tr>
                    <td class="pl-4">{{:status_name}}</td>
                    <td data-link="class{:(sum_total)? 'text-success':''}">{{:value}}</td>
                    </tr>
                    {{/for}}
                {{/for}}
            </tbody>
        </table>
    {{else sp_filter}}
        <table class="table table-hover table-striped">
            <thead><tr>
            <th>{^{:sp_filter_name}} - {^{:sp_filter}}</th>
            <th>К-во занятий</th>
            <th>Сумма</th>
            </tr></thead>
            <tbody>
                {^{for sp_rows }}
                <tr>
                <td width="85%">
                    <a href="#" data-link="{on ~showSp}">{{:name}}</a>
                </td>
                <td>{{:cnt_rows}}</td>
                <td>{{formatDigits:total}}</td>
                </tr>
                {{/for}}
            </tbody>
        </table>
    {{/if}}
    </div>
</div>

{{else}}
    <div class="alert alert-warning">Нет данных</div>
{{/if}}
</script>

<script>
var ratingData = {
    fields: {
        trainer: 'Тренер',
        club: 'Зал',
        squad: 'Группа',
        sportsmen: 'Спортсмены'
    },
    rfields: 'trainer,club,squad'.split(',')
};

function getFrows(field, filter) {
    var tf = typeof filter;
    var rows = $.map(ratingData.d[field], function(r, i){
        var sportsmens = { }; 
        var row = {
            f: field,
            total: 0, cnt_sp: 0, cnt_rows: 0,
            name: r[0][field+'_name'],
            id: r[0][field]
        };
        $.each(r, function(n, v){
            if (tf != 'function' || filter(v)) {
                if (!sportsmens[v.sportsmen]) {
                    sportsmens[v.sportsmen] = 1;
                    row.cnt_sp++;
                }
                row.cnt_rows++;
                row.total += v.sum_value*1;
            }
        });
        if (row.cnt_sp) {
            row.avg = row.total / row.cnt_sp;
            return row;
        }
    });
    rows.sort(function(a,b){
        return a["name"].localeCompare(b["name"]); 
    });
    return rows;
}

$.link(true, '#ratingReport', ratingData, {
    spDate: function(date) {
        return $.map(ratingData.spData, function(v, i) {
            if (v.datestart==date) return v;
        });
    },
    showSp0: function(e, data) {
        $.observable(ratingData).setProperty('spData', null);
    },
    showSp: function(e, data) {
        e.preventDefault();
        var d = data.linkCtx.data;

        pJSON(dataUrl, $.extend({
            table: 'idRate',
            _where: 'sportsmen='+ d.id
        }, clubReport.dates), function(data){
            var nd = {
                sp_name: d.name,
                spDates: unique_ar($.map(data.rows, function(v, i) {
                    if (v.status_extended && (v.status_extended.indexOf('sum":"total') > -1)) v.sum_total = 1;
                    return v.datestart;
                })),
                spData: data.rows
            };
            $.observable(ratingData).setProperty(nd);
        });
    },
    showRows: function(f, e, data) {
        e.preventDefault();
        var lnk = data.linkCtx.data;
        var sp_rows = getFrows('sportsmen', function(v) {
            return v[lnk.f] == lnk.id;
        });
        $.observable(ratingData).setProperty({
            spData: null,
            sp_rows: sp_rows,
            sp_filter: lnk.name,
            sp_filter_name: ratingData.fields[f]
        });
    },
    getFrows: getFrows
});

$.observable(clubReport).setProperty('opts', {
    postData : {
        table: 'idRate',
        _report: 'RateReport'
    },
    callback: function(data) {
        var d = {};
        
        function add_d(f, v){
            if (!d[f]) d[f] = { };
            if (!d[f][ v[f] ]) d[f][ v[f] ] = [];
            d[f][ v[f] ].push(v);
        }
        $.each(data.rows, function(i, v){
            $.each(ratingData.fields, function(f, label){
                add_d(f, v);
            });
        });
        $.observable(ratingData).setProperty({
            d: d,
            sp_filter: ''
        });
    }
});
</script>